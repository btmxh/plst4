{{define "head"}}
<script src="/scripts/watch.js" type="module" defer></script>
<script src="/scripts/websocket.js" type="module" defer></script>
{{end}}

{{define "queue"}}
<form hx-target="this" hx-include='*' hx-swap="outerHTML">
  {{$name := "url"}}
  <section class="add-section">
    <input class="url-bar" type="text" name="url" placeholder="URL" value="{{Get .Context $name}}">
    <select name="add-position" class="preserve">
      <option value="add-to-start" {{if eq (Get .Context "add-position" ) "add-to-start" }}selected{{end}}>Add to start
      </option>
      <option value="add-to-end" {{if eq (Get .Context "add-position" ) "add-to-end" }}selected{{end}}>Add to end
      </option>
      <option value="queue-next" {{if eq (Get .Context "add-position" ) "queue-next" }}selected{{end}}>Queue next
      </option>
    </select>
    <input class="accent-background" type="submit" value="Add" hx-post="/watch/{{.Id}}/queue/add" hx-swap="none">
  </section>
  <hr>
  <div class="button-bar">
    <input class="base-background" type="submit" value="refresh" hx-get="/watch/{{.Id}}/queue?page={{.ThisPage}}"
      hx-trigger="click, refresh-playlist from:body">
    <input class="accent-background" type="submit" value="delete" hx-delete="/watch/{{.Id}}/queue/delete">

    <input class="base-background" type="submit" value="<<" hx-get="/watch/{{.Id}}/queue">
    {{if .PrevPage}}
    <input class="base-background" type="submit" value="<" hx-get="/watch/{{.Id}}/queue?page={{.PrevPage}}">
    {{end}}
    {{if .NextPage}}
    <input class="base-background" type="submit" value=">" hx-get="/watch/{{.Id}}/queue?page={{.NextPage}}">
    {{end}}
    <input class="base-background" type="submit" value=">>" hx-get="/watch/{{.Id}}/queue?page=0">
  </div>

  <section class="playlist-items">
    {{if eq (len .Items) 0}}
    <h1 class="centered">Playlist is empty</h1>
    {{else}}
    {{$thisPage := .ThisPage}}
    {{$playlistId := .Id}}
    {{$current := .Current}}
    {{$context := .Context}}
    {{$isOwner := eq (GetUsername .Context) .Owner}}
    {{range $item := .Items}}
    <div class="playlist-entry">
      <span class="playlist-entry-length">{{FormatDuration $item.Duration}}</span>
      {{$selected := eq (Get $context (print "pic-" $item.Id)) "on"}}
      <input type="checkbox" name="pic-{{$item.Id}}" id="playlist-item-{{$item.Id}}" class="preserve" {{if
        $selected}}checked{{end}}>
      {{$isCurrent := eq $item.Id $current}}
      <label for="playlist-item-{{$item.Id}}" class="{{if $isCurrent}}current-item{{end}}">
        {{if $isCurrent}}
        <span class="current-item-gt">&gt;</span>
        {{end}}
        {{HumanIndex $item.Index}}. {{$item.Title}} - {{$item.Artist}}
      </label>
      <span class="playlist-utilities">
        <a href="{{$item.URL}}" target="_blank">link</a>
        <button type="button" class="link-button" onclick="copyPrevLink(event)">copy</button>
        {{if $isOwner}}
        <input class="link-button" type="submit" hx-patch="/watch/{{$playlistId}}/queue/goto/{{$item.Id}}" value="goto"
          hx-params='pih-{{$item.Id}},index,state-hash,.preserve'>
        {{end}}
      </span>
    </div>
    {{end}}
    {{end}}
  </section>
</form>
{{end}}

{{define "controller"}}
<section class="playlist-info">
  {{if eq (GetUsername .Context) .Owner}}
  <div class="button-bar">
    <button class="base-background" hx-patch="/watch/{{.Id}}/controller/rename" hx-prompt="Enter the new playlist name"
      hx-target="#playlist-controller" hx-swap="innerHTML">Rename</button>
    <button class="accent-background" hx-delete="/watch/{{.Id}}/controller/delete"
      hx-confirm="Are you sure you want to delete this playlist?">Delete</button>
  </div>
  {{end}}
  <h2> Current playlist: {{.Name}} </h2>
  <p> Created by {{.Owner}} at {{FormatTimestampUTC .CreatedTimestamp}} </p>
</section>
{{$id := .Id}}
{{with .Media}}
<hr>
<section class="current-media-info">
  <div class="grid">
    <label for="media-title">Title</label>
    <input type="text" id="media-title" value="{{.Title}}">
    <button class="link-button" onclick="copyPrevInput(event)">copy</button>
    <label for="media-artist">Artist</label>
    <input type="text" id="media-artist" value="{{.Artist}}">
    <button class="link-button" onclick="copyPrevInput(event)">copy</button>
    <label for="media-original-title">Original title</label>
    <input type="text" id="media-original-title" value="{{.OriginalTitle}}" readonly>
    <button class="link-button" onclick="copyPrevInput(event)">copy</button>
    <label for="media-original-artist">Original artist</label>
    <input type="text" id="media-original-artist" value="{{.OriginalArtist}}" readonly>
    <button class="link-button" onclick="copyPrevInput(event)">copy</button>
  </div>
  <div class="button-bar">
    <button class="base-background" hx-get="/watch/{{$id}}/controller" hx-target="#playlist-controller"
      hx-swap="innerHTML">Reset</button>
    <button class="accent-background" hx-post="/">Submit</button>
  </div>
</section>
<hr>
<section class="current-media-details">
  <p>Media duration: {{FormatDuration .Duration}}</p>
  <p>Media added on 2024-12-04T05:21:20, 31 view(s)</p>
  <p>Playlist item added on 2024-12-04T05:21:20</p>
</section>
{{end}}

<hr>
<section>
  <p><strong>Debug info:</strong></p>
  <p>Playlist ID: {{.Id}}</p>
  {{with .Media}}
  <p>Media ID: {{.Id}}, type: {{.Type}}</p>
  <p>Playlist item ID: {{.ItemId}}</p>
  <p>Media URL: <a href="{{.URL}}" target="_blank">{{.URL}}</a></p>
  {{end}}
</section>
{{end}}

{{define "body"}}
{{$loggedIn := HasUsername .Context}}
<main class="main-content no-border no-margin no-padding full {{if .ErrorString}}noanim{{end}}" hx-target="closest main"
  hx-swap="outerHTML" data-playlist={{.Id}}>
  <input id="websocket-id-input" type="hidden" name="websocket-id" value="">
  <link rel="stylesheet" href="/styles/playlist-watch.css" type="text/css">
  <article>Video placeholder</article>
  <aside class="playlist-details">
    <nav class="tab-bar">
      <ul>
        <li>
          <input type="radio" id="tab-queue" class="tab-radio" name="playlist-details-tab" checked>
          <label for="tab-queue">queue</label>
        </li>
        <li>
          <input type="radio" id="tab-controller" class="tab-radio" name="playlist-details-tab">
          <label for="tab-controller">controller</label>
        </li>
      </ul>
    </nav>
    <section id="playlist-queue" class="tab-content" hx-trigger="load" hx-get="/watch/{{.Id}}/queue" hx-swap="innerHTML"
      hx-target="this">
    </section>
    <section id="playlist-controller" class="tab-content" hx-trigger="load, refresh-playlist from:body"
      hx-get="/watch/{{.Id}}/controller" hx-swap="innerHTML" hx-target="this">
    </section>
  </aside>
</main>
{{end}}
